<?php	// Required files	require("config.php");	if (REWRITE_GLOBALS == "ON") { include("functions/register_globals.php"); }	require(CLASSES_DIR."template.php"); // include the template class	require(CLASSES_DIR."db_mysql.php"); // include the db class	require(CLASSES_DIR."container.php");	require(CLASSES_DIR."session.php");	require(CLASSES_DIR."authentication.php");	require(CLASSES_DIR."page.php");	require(CLASSES_DIR."class_mailer.php");	include("functions/access.php");	page_open(array("session" => "session_object", "authenticate" => "Auth"));	page_close();	include("interface/lang/".$Auth->auth["language"].".php");	// check if we have the correct access rights	$access_rights = _getUserAccessRights($Auth->auth['user_id']);	if (!isset($access_rights['pages']['workspace'])) {		// display the error message		ui_output_error("<strong>Pages</strong><br /><br /> ".LANG_NoAccessRights);		exit;	}	function export_csv($table, $from_id='') {		$host = 'localhost';		$user = 'root';		$pass = '1ctsql';		$db = 'conel';			$separator = ',';		$link = mysql_connect($host, $user, $pass) or die("Can not connect." . mysql_error());		mysql_select_db($db) or die("Can not connect.");		$result = mysql_query("SHOW COLUMNS FROM ".$table."");		$i = 0;		if (mysql_num_rows($result) > 0) {			while ($row = mysql_fetch_assoc($result)) {				$values[] = '"'.$row['Field'].'"';				$i++;			}		}		// implode values				$csv_output .= implode(',', $values);		$csv_output .= "\n";				// Get total number of rows inside table		if ($from_id != '' && is_numeric($from_id)) {			$row_from = $from_id - 1;			$query = "SELECT * FROM $table WHERE id > $row_from";		} else {			$query = "SELECT * FROM $table";		}				$values = mysql_query($query);				while ($rowr = mysql_fetch_row($values)) {			for ($j=0; $j < $i; $j++) {				// check if separator is used in value, if so enclose in quotes					$value = '"'.$rowr[$j].'"';										if ($j == ($i - 1)) {						$csv_output .= $value;						} else {						$csv_output .= $value . $separator;						}									}			$csv_output .= "\n";		}		// Convert underscores to hyphens		$table = str_replace('_', '-', str_replace('tbl_', '', $table));		// old naming structure - included time		//$filename = $table."_".date("Y-m-d_H-i",time());		$filename = $table."_".date("Y-m-d", time());		header("Content-type: application/vnd.ms-excel");		header("Content-disposition: csv" . date("Y-m-d") . ".csv");		header( "Content-disposition: filename=".$filename.".csv");		print $csv_output;		exit;			}		// Get list of tables to export CSV from	$host = 'localhost';	$user = 'root';	$pass = '1ctsql';	$db = 'conel';	$link = mysql_connect($host, $user, $pass) or die("Can not connect." . mysql_error());	mysql_select_db($db) or die("Can not connect.");		// Get a list of tables we should be able to export data from	$query = "SHOW TABLES WHERE Tables_in_conel LIKE ('tbl\_%')";	$result = mysql_query($query);	$csv_tables = array();	if (mysql_num_rows($result) > 0) {		while ($row = mysql_fetch_assoc($result)) {			$csv_tables[] = $row['Tables_in_conel'];		}	}	// Remove tbl_ca_logins and tbl_stewarding	if (in_array('tbl_ca_logins', $csv_tables)) {		$csv_tables = array_values(array_diff($csv_tables, array('tbl_ca_logins')));		$csv_tables = array_values(array_diff($csv_tables, array('tbl_stewarding')));	}		// Get no rows in each table	$i = 0;	$table_data = array();		foreach ($csv_tables as $table) {		$query = "SELECT * FROM $table";		$result = mysql_query($query);		$no_rows = (mysql_num_rows($result)) ? mysql_num_rows($result) : 0; 		$table_data[] = array($table, $no_rows);		$i++;	}	if (isset($_GET['table'])) {				$table = (isset($_GET['table']) && $_GET['table'] != '') ? $_GET['table'] : '';		$from_id = (isset($_GET['from_id']) && $_GET['from_id'] != '') ? $_GET['from_id'] : '';				// Only export CSV for allowed tables		if (in_array($table, $csv_tables)) {			export_csv($table, $from_id); // DO THE EXPORT!		}	}?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en-AU" xml:lang="en-AU"><head><title>Export CSV</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><link href="../layout/css/export_csv.css" rel="stylesheet" type="text/css" /></head><body> <div id="holder">	<h1>Export CSV</h1>	<form action="export_csv.php" method="get">		<h3>Table to export CSV from</h3>		<?php			$session = (isset($_REQUEST['Session'])) ? $_REQUEST['Session'] : '';			foreach ($table_data as $table) {				echo '<input type="radio" name="table" value="'.$table[0].'" id="'.$table[0].'" /> <label for="'.$table[0].'">'.$table[0].' <span class="rows">&nbsp;'.$table[1].'</span></label><br />';			}		?>		<input type="hidden" name="Session" value="<?php echo $session; ?>" />		<h3>From Row Number (optional)</h3>		<input type="text" name="from_id" value="" />		<br /><br />		<input type="submit" value="Export CSV" />	</form></div></body></html>